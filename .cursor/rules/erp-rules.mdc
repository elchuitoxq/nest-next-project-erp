# NestJS + Next.js ERP System Rules & Guidelines

## Technical Stack
- **Backend**: NestJS (Monorepo with Turbo)
- **Frontend**: Next.js 14 (App Router)
- **Database**: PostgreSQL with Drizzle ORM
- **Authentication**: Passport/JWT
- **State Management**: React Query (TanStack Query)
- **UI Components**: Shadcn UI + Tailwind CSS

## Core Business Rules (Venezuela Context)

### 1. Fiscality & Billing
- **Fiscal Currency**: The system MUST report all fiscal books (Sales/Purchases) in **Bolívares (VES)**.
- **Base Currency**: The system is **Dollarized (USD Base)**.
- **Exchange Rates**:
  - `exchangeRate` in Invoices represents "Bs per 1 Unit of Invoice Currency".
  - If Invoice is USD: Rate = Market Rate (e.g., 45.00).
  - If Invoice is VES: Rate = 1.00 (Always enforce this for fiscal calculations).
- **Taxes**:
  - **IVA**: 16% Standard.
  - **IGTF**: 3% Tax on Foreign Currency Payments (Non-VES).
    - Logic: `if (paymentCurrency !== 'VES') apply 3%`.
    - Do NOT rely on `isBase` flag for IGTF, as USD is Base but still subject to IGTF in Venezuela.
- **Fiscal Book Generation**:
  - Normalize all amounts to VES using the Invoice's stored `exchangeRate`.
  - Include `igtfAmount` column in VES.
  - Detail associated payments for audit.

### 2. Inventory Management
- **Movements**:
  - **IN**: Purchases, Returns from Customers.
  - **OUT**: Sales, Returns to Vendors.
- **Valuation**:
  - Costs are tracked in USD (Base).
  - If purchasing in VES, convert to USD for cost tracking.

### 3. Treasury & Payments
- **Methods**: Cash, Zelle, Transfer, Pago Móvil.
- **Multi-currency**: Payments can be in any currency.
- **Allocations**: Payments are allocated to invoices. Cross-currency allocation requires rate conversion at the moment of payment.
- **Retentions**:
  - IVA Retention (75% or 100%) and ISLR Retention are withheld in **Bolívares**.

## Development Conventions

### 1. Database (Drizzle)
- Use `decimal` type for money to avoid floating point errors.
- Always use explicit `exchangeRate` columns in transaction tables (`invoices`, `orders`, `payments`).
- `currencyId` is mandatory for monetary transactions.

### 2. Frontend (Next.js)
- **Currency Formatting**:
  - Use `formatCurrency(amount, symbol)` helper.
  - Explicitly pass the symbol (`Bs`, `$`) to avoid ambiguity.
  - "Bolívares" should be displayed as "Bs" (not "Bs.S" or "Bs.").
- **Dialogs**:
  - Payment Dialogs must calculate IGTF dynamically based on selected method currency.

### 3. Backend Scripts (Seeds)
- **Environment Loading**:
  - Always load `.env` explicitly before importing DB client to avoid race conditions.
  - Use `load-env.ts` helper in `packages/db`.
- **Seeding Logic**:
  - Ensure Fiscal consistency (VES transactions = Rate 1).
  - Use `C-` prefix for Supplier Invoices (Purchases) and `A-` for Sales.

## Common Pitfalls to Avoid
- **Race Conditions**: DB Client init before dotenv.
- **Fiscal Inflation**: Multiplying VES amounts by USD rate in reports.
- **IGTF Logic**: Assuming `isBase === Foreign`. In this project, `isBase` is USD, but IGTF applies to USD.
